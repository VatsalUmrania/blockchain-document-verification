# Google Cloud Build configuration with MongoDB for blockchain document verification system
steps:
  # Step 1: Build the backend service
  - name: "gcr.io/cloud-builders/docker"
    id: "build-backend"
    args: ["build", "-t", "gcr.io/$PROJECT_ID/backend-service:$COMMIT_SHA", "."]
    dir: "backend"

  # Step 2: Build the frontend service
  - name: "gcr.io/cloud-builders/docker"
    id: "build-frontend"
    args:
      ["build", "-t", "gcr.io/$PROJECT_ID/frontend-service:$COMMIT_SHA", "."]
    dir: "frontend_new"

  # Step 3: Push the backend image to Container Registry
  - name: "gcr.io/cloud-builders/docker"
    id: "push-backend"
    args: ["push", "gcr.io/$PROJECT_ID/backend-service:$COMMIT_SHA"]

  # Step 4: Push the frontend image to Container Registry
  - name: "gcr.io/cloud-builders/docker"
    id: "push-frontend"
    args: ["push", "gcr.io/$PROJECT_ID/frontend-service:$COMMIT_SHA"]

  # Step 5: Deploy MongoDB to Cloud Run (using official MongoDB image)
  - name: "gcr.io/google.com/cloudsdktool/cloud-sdk"
    id: "deploy-mongo"
    entrypoint: gcloud
    args:
      - "run"
      - "deploy"
      - "mongodb-service"
      - "--image"
      - "mongo:latest"
      - "--platform"
      - "managed"
      - "--region"
      - "us-central1"
      - "--no-allow-unauthenticated"
      - "--port"
      - "27017"
      - "--set-env-vars"
      - "MONGO_INITDB_ROOT_USERNAME=$_MONGO_USER,MONGO_INITDB_ROOT_PASSWORD=$_MONGO_PASSWORD"
      - "--memory"
      - "1Gi"
      - "--cpu"
      - "1"
      - "--volume"
      - "name=mongo-storage, mount-path=/data/db"
      - "--persistence"
      - "name=mongo-storage,size=10Gi"

  # Step 6: Deploy backend service to Cloud Run
  - name: "gcr.io/google.com/cloudsdktool/cloud-sdk"
    id: "deploy-backend"
    entrypoint: gcloud
    args:
      - "run"
      - "deploy"
      - "backend-service"
      - "--image"
      - "gcr.io/$PROJECT_ID/backend-service:$COMMIT_SHA"
      - "--platform"
      - "managed"
      - "--region"
      - "us-central1"
      - "--allow-unauthenticated"
      - "--port"
      - "5000"
      - "--set-env-vars"
      - "NODE_ENV=production,PORT=5000,MONGO_URI=mongodb://$_MONGO_USER:$_MONGO_PASSWORD@mongodb-service:27017/document_verification,JWT_SECRET=$_JWT_SECRET,SESSION_SECRET=$_SESSION_SECRET,CONTRACT_ADDRESS=$_CONTRACT_ADDRESS,RPC_URL=$_RPC_URL"
      - "--memory"
      - "512Mi"

  # Step 7: Deploy frontend service to Cloud Run
  - name: "gcr.io/google.com/cloudsdktool/cloud-sdk"
    id: "deploy-frontend"
    entrypoint: gcloud
    args:
      - "run"
      - "deploy"
      - "frontend-service"
      - "--image"
      - "gcr.io/$PROJECT_ID/frontend-service:$COMMIT_SHA"
      - "--platform"
      - "managed"
      - "--region"
      - "us-central1"
      - "--allow-unauthenticated"
      - "--port"
      - "5173"
      - "--memory"
      - "512Mi"

# Define images to be pushed to Container Registry
images:
  - "gcr.io/$PROJECT_ID/backend-service:$COMMIT_SHA"
  - "gcr.io/$PROJECT_ID/frontend-service:$COMMIT_SHA"

# Define substitutions that can be provided during build trigger
substitutions:
  _MONGO_USER: "admin"
  _MONGO_PASSWORD: "password"
  _JWT_SECRET: "your_jwt_secret_key_here"
  _SESSION_SECRET: "your_session_secret_here"
  _CONTRACT_ADDRESS: "0x5FbDB2315678afecb367f032d93F642f64180aa3"
  _RPC_URL: "https://sepolia.infura.io/v3/YOUR_INFURA_PROJECT_ID"

# Timeout for the entire build process
timeout: 1200s
